<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="logo.png" />
  <title>EAN Label AI Chatbot</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #f4f4f4; }
    ::-webkit-scrollbar { width: 8px; background: #f4f4f4; }
    ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 4px; }
    .typing-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background-color: #9ca3af;
      animation: typing 1.5s infinite;
    }
    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-10px); }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center bg-[#f4f4f4]">
  <!-- EAN Label Navbar -->
  <nav class="w-full bg-white flex items-center justify-between px-6 py-2 shadow-sm border-b border-gray-100 fixed top-0 left-0 z-50" style="min-height:64px;">
    <div class="flex items-center gap-2">
      <div class="flex flex-col items-start leading-none select-none">
        <a href="https://eanlabel.com.my/">
          <img src="logo.png" alt="EAN Label Logo" class="h-12 w-auto" />
        </a>
      </div>
    </div>
    <div class="hidden md:flex items-center gap-8">
      <a href="https://eanlabel.com.my/" class="text-gray-400 hover:text-[#1e2a39] font-medium transition">Home</a>
      <a href="https://eanlabel.com.my/about-us/" class="text-gray-400 hover:text-[#1e2a39] font-medium transition">About</a>
      <div class="relative group">
        <button type="button" class="flex items-center gap-1 font-medium text-gray-400 hover:text-[#d7263d] focus:text-[#d7263d] transition focus:outline-none cursor-pointer">
          Products
          <svg class="w-4 h-4 text-[#d7263d] group-hover:rotate-180 group-focus:rotate-180 transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
        </button>
        <div class="absolute left-0 top-full w-56 bg-white rounded-xl shadow-lg border border-gray-100 border-t-2 border-t-[#d7263d] opacity-0 scale-y-95 group-hover:opacity-100 group-hover:scale-y-100 group-focus-within:opacity-100 group-focus-within:scale-y-100 visible invisible group-hover:visible group-focus-within:visible pointer-events-none group-hover:pointer-events-auto group-focus-within:pointer-events-auto transition-all duration-200 origin-top z-50">
          <a href="https://eanlabel.com.my/stickers-labels/" class="block px-6 py-3 font-bold text-black hover:text-[#d7263d] rounded-t-xl transition">Stickers & Labels</a>
          <a href="https://eanlabel.com.my/flexible-packaging/" class="block px-6 py-3 font-bold text-black hover:text-[#d7263d] transition">Flexible Packaging</a>
          <a href="https://eanlabel.com.my/packaging-boxes/" class="block px-6 py-3 font-bold text-black hover:text-[#d7263d] rounded-b-xl transition">Packaging Boxes</a>
        </div>
      </div>
      <div class="relative group">
        <a href="https://eanlabel.com.my/technology/" class="flex items-center gap-1 font-medium text-gray-400 hover:text-[#d7263d] focus:text-[#d7263d] transition focus:outline-none cursor-pointer">
          Technology
          <svg class="w-4 h-4 text-[#d7263d] group-hover:rotate-180 group-focus:rotate-180 transition-transform" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
        </a>
        <div class="absolute left-0 top-full w-56 bg-white rounded-xl shadow-lg border border-gray-100 border-t-2 border-t-[#d7263d] opacity-0 scale-y-95 group-hover:opacity-100 group-hover:scale-y-100 group-focus-within:opacity-100 group-focus-within:scale-y-100 visible invisible group-hover:visible group-focus-within:visible pointer-events-none group-hover:pointer-events-auto group-focus-within:pointer-events-auto transition-all duration-200 origin-top z-50">
          <a href="https://eanlabel.com.my/technology/ensmart-packaging/" class="block px-6 py-3 font-bold text-black hover:text-[#d7263d] rounded-t-xl transition">EnSmart Packaging</a>
          <a href="https://eanlabel.com.my/go-authentic/" class="block px-6 py-3 font-bold text-black hover:text-[#d7263d] rounded-b-xl transition">Go Authentic</a>
        </div>
      </div>
      <a href="https://eanlabel.com.my/blog/" class="text-gray-400 hover:text-[#1e2a39] font-medium transition">Blog</a>
      <a href="https://eanlabel.com.my/contact-us/" class="text-gray-400 hover:text-[#1e2a39] font-medium transition">Contact Us</a>
    </div>
    <div class="flex items-center">
      <a href="https://wa.me/60189632039" class="bg-red-600 hover:bg-red-700 text-white font-bold px-6 py-2 rounded-full shadow transition text-base">Get In Touch!</a>
    </div>
  </nav>
  <div class="w-full flex justify-center items-stretch max-w-7xl mx-auto pt-24 gap-4">
    <!-- Left Educational Panel (hidden on mobile) -->
    <aside class="hidden lg:flex flex-col w-80 bg-white/70 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-200 p-6 mr-2 animate-fade-in overflow-y-auto max-h-[85vh] relative">
      <div>
        <div class="absolute top-6 right-6 opacity-10 pointer-events-none select-none">
          <img src="logo.png" alt="EAN Label Watermark" class="w-20 h-20" />
        </div>
        <h2 class="text-xl font-bold text-[#1e2a39] mb-4 flex items-center gap-2">
          <svg class="w-6 h-6 text-[#d4af37]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M12 20a8 8 0 100-16 8 8 0 000 16z" /></svg>
          Why use the EAN Label AI Chatbot?
        </h2>
        <ul class="space-y-0 text-[#1e2a39] text-base divide-y divide-gray-200">
          <li class="flex items-start gap-3 py-4 first:pt-0 last:pb-0">
            <span class="flex items-center justify-center w-7 h-7 rounded-full bg-[#d4af37] text-white font-bold text-lg flex-shrink-0 mt-1">1</span>
            <span><b>Smarter customer engagement</b><br><span class="text-gray-500">Get instant answers and tailored support 24/7.</span></span>
          </li>
          <li class="flex items-start gap-3 py-4">
            <span class="flex items-center justify-center w-7 h-7 rounded-full bg-[#d4af37] text-white font-bold text-lg flex-shrink-0 mt-1">2</span>
            <span><b>Faster quote generation</b><br><span class="text-gray-500">Receive quick, accurate packaging quotes for your needs.</span></span>
          </li>
          <li class="flex items-start gap-3 py-4">
            <span class="flex items-center justify-center w-7 h-7 rounded-full bg-[#d4af37] text-white font-bold text-lg flex-shrink-0 mt-1">3</span>
            <span><b>Streamlined internal operations</b><br><span class="text-gray-500">Reduce manual workload and speed up your project pipeline.</span></span>
          </li>
          <li class="flex items-start gap-3 py-4">
            <span class="flex items-center justify-center w-7 h-7 rounded-full bg-[#d4af37] text-white font-bold text-lg flex-shrink-0 mt-1">4</span>
            <span><b>Modern digital experience</b><br><span class="text-gray-500">Enjoy a seamless, branded interaction aligned with EAN Label's values.</span></span>
          </li>
        </ul>
      </div>
      <a href="https://eanlabel.com.my/#contact" class="mt-0 w-full inline-block text-center bg-[#d4af37] hover:bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg shadow transition text-base">Learn More / Contact Us</a>
    </aside>
    <!-- Main Chatbox -->
    <div class="w-full max-w-2xl flex flex-col h-[90vh]">
      <div class="flex items-center justify-center mb-4">
        <img src="https://eanlabel.com.my/eanflexi/wp-content/themes/ean/images/logo.png" alt="EAN Label Logo" class="w-12 h-12 mr-2" />
        <h1 class="text-2xl font-bold text-[#1e2a39]">EAN Label AI Chatbot</h1>
      </div>
      <div id="chat-card" class="flex flex-col flex-1 bg-white rounded-2xl shadow-xl border border-gray-200 p-4 md:p-8 overflow-hidden">
        <div id="chat-history" class="flex-1 overflow-y-auto mb-4 pr-2">
          <div id="chat-messages" class="flex flex-col space-y-4"></div>
        </div>
        <form id="chat-form" class="flex items-center gap-2 mt-auto">
          <input id="chat-input" type="text" placeholder="Type your message..." class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#d4af37] focus:outline-none" autocomplete="off" />
          <button type="submit" id="send-button" class="px-5 py-3 rounded-lg font-medium bg-[#d4af37] text-white hover:bg-yellow-500 transition disabled:bg-gray-400 disabled:cursor-not-allowed">Send</button>
        </form>
      </div>
      <div class="mt-4 text-center text-xs text-gray-400">
        &copy; <span id="year"></span> EAN Label Industry Sdn. Bhd. All rights reserved.
      </div>
    </div>
    <!-- Right Interactive Tips Panel (hidden on mobile) -->
    <aside class="hidden lg:flex flex-col justify-between w-80 bg-white/70 backdrop-blur-md rounded-2xl shadow-2xl border border-gray-200 p-6 ml-2 animate-fade-in overflow-y-auto max-h-[85vh]">
      <div>
        <h2 class="text-xl font-bold text-[#1e2a39] mb-4 flex items-center gap-2">
          <svg class="w-6 h-6 text-[#d4af37]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 14h.01M16 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          Tips & How to Get the Most Out of Chatbot
        </h2>
        <ul class="space-y-0 text-[#1e2a39] text-base divide-y divide-gray-200">
          <li class="flex items-start gap-3 py-4 transition rounded-lg">
            <span class="flex items-center justify-center w-7 h-7 rounded-full bg-green-500 text-white font-bold text-lg flex-shrink-0 mt-1">✓</span>
            <span>Ask about <b>packaging types, materials, or printing options</b> for instant info.</span>
          </li>
          <li class="flex items-start gap-3 py-4 transition rounded-lg">
            <span class="flex items-center justify-center w-7 h-7 rounded-full bg-green-500 text-white font-bold text-lg flex-shrink-0 mt-1">✓</span>
            <span>Request a <b>quick quote</b> by describing your packaging needs.</span>
          </li>
          <li class="flex items-start gap-3 py-4 transition rounded-lg">
            <span class="flex items-center justify-center w-7 h-7 rounded-full bg-green-500 text-white font-bold text-lg flex-shrink-0 mt-1">✓</span>
            <span>Learn about <b>minimum order quantities, lead times, or available finishes</b>.</span>
          </li>
          <li class="flex items-start gap-3 py-4 transition rounded-lg">
            <span class="flex items-center justify-center w-7 h-7 rounded-full bg-green-500 text-white font-bold text-lg flex-shrink-0 mt-1">✓</span>
            <span>Use the chatbot for <b>order status, lead times, or support</b> questions.</span>
          </li>
          <li class="flex items-start gap-3 py-4 transition rounded-lg">
            <span class="flex items-center justify-center w-7 h-7 rounded-full bg-green-500 text-white font-bold text-lg flex-shrink-0 mt-1">✓</span>
            <span>Try <b>"What makes EAN Label different?"</b> or <b>"Show me your latest products"</b>.</span>
          </li>
          <li class="flex items-start gap-3 py-4 transition rounded-lg">
            <span class="flex items-center justify-center w-7 h-7 rounded-full bg-green-500 text-white font-bold text-lg flex-shrink-0 mt-1">✓</span>
            <span>Send <b>emails or inquiries directly from the chatbot</b> for customer service convenience.</span>
          </li>
        </ul>
      </div>
      <div class="mt-6 p-3 bg-[#f4f4f4] rounded-xl text-sm text-gray-600">
        <b>Pro Tip:</b> The more details you provide, the better the AI can assist you!
      </div>
      <div class="mt-4 text-xs text-gray-400">
        <span class="font-semibold text-[#d4af37]">Interactive:</span> Try clicking on a tip to auto-fill the chat input!
      </div>
    </aside>
  </div>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    // Persistent session ID for the entire chat session
    const sessionId = 'session_' + Date.now();
    const chatHistory = document.getElementById('chat-history');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');
    const sendButton = document.getElementById('send-button');

    // Initialize with welcome message
    const messages = [
      { sender: 'bot', text: 'Hello! I am the EAN Label AI assistant. How can I help you today with your packaging and printing needs?' }
    ];

    function renderMessages() {
      const chatMessages = document.getElementById('chat-messages');
      chatMessages.innerHTML = '';
      messages.forEach((msg, index) => {
        const align = msg.sender === 'user' ? 'justify-end' : 'justify-start';
        const bg = msg.sender === 'user' ? 'bg-[#d4af37] text-white' : 'bg-[#f4f4f4] text-[#1e2a39]';
        const border = msg.sender === 'user' ? '' : 'border border-gray-200';
        if (msg.isTyping) {
          chatMessages.innerHTML += `
            <div class="flex ${align}" id="typing-message">
              <div class="max-w-[75%] px-4 py-3 rounded-xl ${bg} ${border} shadow-sm">
                <div class="typing-indicator">
                  <span class="text-sm mr-2">AI is thinking</span>
                  <div class="typing-dot"></div>
                  <div class="typing-dot"></div>
                  <div class="typing-dot"></div>
                </div>
              </div>
            </div>
          `;
        } else {
          let displayText = msg.text;
          if (msg.sender === 'bot') {
            // Replace **text** with "text"
            displayText = displayText.replace(/\*\*(.*?)\*\*/g, '"$1"');
            // Remove markdown ### from the start of lines
            displayText = displayText.replace(/^###\s*/gm, '');
          }
          // 1. Render Markdown images: ![alt](url)
          const markdownImgRegex = /!\[([^\]]*)\]\((https?:\/\/(?:[\w.-]+)\/(?:[\w\-.~:/?#\[\]@!$&'()*+,;=%]+)\.(?:jpg|jpeg|png|gif|webp))\)/gi;
          let htmlContent = '';
          let lastIndex = 0;
          let match;
          let hasImage = false;
          while ((match = markdownImgRegex.exec(displayText)) !== null) {
            hasImage = true;
            // Add text before the image markdown
            htmlContent += escapeHtml(displayText.substring(lastIndex, match.index));
            // Add the image
            const alt = match[1] || 'Image';
            const url = match[2];
            htmlContent += `<img src="${url}" alt="${escapeHtml(alt)}" class="my-2 rounded-lg border max-w-xs max-h-60 object-contain" style="display:block;" loading="lazy" />`;
            lastIndex = markdownImgRegex.lastIndex;
          }
          if (hasImage) {
            // Add any remaining text after the last image markdown
            displayText = displayText.substring(lastIndex);
          } else {
            htmlContent = '';
          }
          // 2. Render direct image URLs in the remaining text
          const imageUrlRegex = /(https?:\/\/(?:[\w.-]+)\/(?:[\w\-.~:/?#\[\]@!$&'()*+,;=%]+)\.(?:jpg|jpeg|png|gif|webp))(?![\w.])/gi;
          let lastUrlIndex = 0;
          let urlMatch;
          let hasDirectImage = false;
          let urlContent = '';
          while ((urlMatch = imageUrlRegex.exec(displayText)) !== null) {
            hasDirectImage = true;
            urlContent += escapeHtml(displayText.substring(lastUrlIndex, urlMatch.index));
            const url = urlMatch[1];
            urlContent += `<img src="${url}" alt="Image" class="my-2 rounded-lg border max-w-xs max-h-60 object-contain" style="display:block;" loading="lazy" />`;
            lastUrlIndex = imageUrlRegex.lastIndex;
          }
          if (hasDirectImage) {
            urlContent += escapeHtml(displayText.substring(lastUrlIndex));
          } else {
            urlContent = escapeHtml(displayText);
          }
          // Combine both htmlContent (markdown images) and urlContent (direct URLs)
          chatMessages.innerHTML += `
            <div class="flex ${align}">
              <div class="max-w-[75%] px-4 py-2 rounded-xl ${bg} ${border} shadow-sm${msg.sender === 'bot' ? ' whitespace-pre-line' : ''}">${htmlContent}${urlContent}</div>
            </div>
          `;
        }
      });
      chatHistory.scrollTop = chatHistory.scrollHeight;
    }

    // Helper to escape HTML (to prevent XSS)
    function escapeHtml(text) {
      if (!text) return '';
      return text.replace(/[&<>"']/g, function (c) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\'':'&#39;'}[c];
      });
    }

    function showTypingIndicator() {
      messages.push({ sender: 'bot', text: '', isTyping: true });
      renderMessages();
    }

    function hideTypingIndicator() {
      // Remove the typing message
      const typingIndex = messages.findIndex(msg => msg.isTyping);
      if (typingIndex !== -1) {
        messages.splice(typingIndex, 1);
      }
    }

    async function sendToN8N(userMessage) {
      try {
        const response = await fetch('https://spark3consulting.app.n8n.cloud/webhook/cb766c56-63c1-43c8-a266-61fdde7210d2/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            chatInput: userMessage, // This matches what your N8N expects
            sessionId: sessionId,
            timestamp: new Date().toISOString()
          })
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        // Based on your test, the AI response is in data.output
        return data.output || data.reply || data.message || 'Sorry, I could not generate a response.';

      } catch (error) {
        console.error('Error calling N8N webhook:', error);
        throw error;
      }
    }

    chatForm.onsubmit = async (e) => {
      e.preventDefault();
      const text = chatInput.value.trim();
      if (!text) return;

      // Disable send button and input during processing
      sendButton.disabled = true;
      chatInput.disabled = true;
      sendButton.textContent = 'Sending...';

      // Add user message
      messages.push({ sender: 'user', text: text });
      renderMessages();
      
      // Clear input
      chatInput.value = '';

      // Show typing indicator
      showTypingIndicator();

      try {
        // Send to N8N webhook
        const botResponse = await sendToN8N(text);
        
        // Hide typing indicator
        hideTypingIndicator();
        
        // Add bot response
        messages.push({ sender: 'bot', text: botResponse });
        renderMessages();

      } catch (error) {
        console.error('Chat error:', error);
        
        // Hide typing indicator
        hideTypingIndicator();
        
        // Add error message
        messages.push({ 
          sender: 'bot', 
          text: 'Sorry, I encountered an error while processing your request. Please try again.' 
        });
        renderMessages();
      } finally {
        // Re-enable send button and input
        sendButton.disabled = false;
        chatInput.disabled = false;
        sendButton.textContent = 'Send';
        chatInput.focus();
      }
    };

    // Initialize chat
    renderMessages();
    chatInput.focus();
  </script>
</body>
</html> 